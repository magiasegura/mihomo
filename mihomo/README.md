- MiHoMo ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ —Ñ–æ—Ä–∫–æ–≤ Clash, —Ç–æ—á–Ω–µ–µ, —Ñ–æ—Ä–∫ Clash.Meta, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º —è–≤–ª—è–µ—Ç—Å—è –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º –æ—Ç–≤–µ—Ç–≤–ª–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ Clash. –ï–≥–æ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ ‚Äî Clash.Meta-Mihomo. (ChatGPT)
- mihomo —ç—Ç–æ –ø—Ä–æ–∫—Å–∏-–∫–æ–º–±–∞–π–Ω, –∫–∞–∫ xray –∏ sing-box, mihomo —ç—Ç–æ tun –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –¥–Ω—Å-—Å–µ—Ä–≤–µ—Ä, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ —Ç–∞–∫–∏—Ö –∫–∞–∫ vless, amnezia-wg –∏ –º–Ω–æ–≥–∏—Ö –¥—Ä—É–≥–∏—Ö, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–∑—ã ASN, MMDB, Geoip, Geosite, Rulesets.
# –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Mikrotik RouterOS, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç nftables. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–±—Ä–∞–Ω –Ω–∞ –±–∞–∑–µ alpine linux 3.18 –≥–¥–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è iptables-legacy. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DISABLE_NFTABLES=1 –¥–ª—è mihomo –æ—Ç–∫–ª—é—á–∞—é—â–∞—è nftables.

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è mihomo –≤–º–µ—Å—Ç–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º byedpi –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π "Fakeip":
–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä mihomo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è dhcp –∫–ª–∏–µ–Ω—Ç–∞–º–∏ —Ä–æ—É—Ç–µ—Ä–∞ –∫–∞–∫ dns —Å–µ—Ä–≤–µ—Ä, –æ–Ω —Ä–µ–∑–æ–ª–≤–∏—Ç –Ω—É–∂–Ω—ã–µ –Ω–∞–º –¥–æ–º–µ–Ω—ã –≤ "—Ñ–µ–π–∫–æ–≤—ã–µ" –∞–¥—Ä–µ—Å–∞ –∏–∑ –ø–æ–¥—Å–µ—Ç–∏ 198.18.0.0/15 –∫–æ—Ç–æ—Ä—ã–µ –º—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ–º –≤ —ç—Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä mihomo —Å–∏–ª–∞–º–∏ RouterOS. –î–∞–ª–µ–µ –ø—Ä–æ–π–¥—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é mihomo –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ø–∞–¥—É—Ç –≤ –Ω—É–∂–Ω—ã–π –Ω–∞–º outbound. –û–¥–Ω–∏–º –∏–∑ —ç—Ç–∏—Ö outbound –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å byedpi.

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞:

- –ü–∞–∫–µ—Ç containers –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ /system/device-mode. –í –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è hap ax lite. –í–µ—Ä—Å–∏—è RouterOS 7.19.3 Mihomo 1.19.12
- RouterOS —Å–±—Ä–æ—à–µ–Ω–∞ –¥–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–Ω–µ –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥).

1: –°–æ–∑–¥–∞–¥–∏–º tmpfs –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:
```
/disk add type=tmpfs tmpfs-max-size=50M
```
2: –ó–∞–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:
```
/container config set tmpdir=/tmp1
```
3: –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ mihomo –∏ byedpi, –Ω–∞–∑–Ω–∞—á–∞–µ–º –∞–¥—Ä–µ—Åa –∏ —à–ª—é–∑:
```
/interface veth add address=10.10.10.2/24 gateway=10.10.10.1
/interface veth add address=10.10.10.3/24 gateway=10.10.10.1
```
4: –°–æ–∑–¥–∞—ë–º –±—Ä–∏–¥–∂ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–µ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
```
/interface bridge add name=dockers
/interface bridge port add bridge=dockers interface=veth1
/interface bridge port add bridge=dockers interface=veth2
```
5: –ù–∞–∑–Ω–∞—á–∞–µ–º –∞–¥—Ä–µ—Å –±—Ä–∏–¥–∂ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É:
```
/ip address add address=10.10.10.1/24 interface=dockers network=10.10.10.0
```
6: –°–æ–∑–¥–∞—ë–º –º–∞—Ä—à—Ä—É—Ç –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å fakeip –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```
/ip route add comment="fake-ip cidr to container" disabled=no distance=1 dst-address=198.18.0.0/15 gateway=10.10.10.2 routing-table=main scope=30 suppress-hw-offload=no target-scope=10
```
7: —Å–æ–∑–¥–∞—ë–º –º–∞—É–Ω—Ç –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞:
```
/container mounts add dst=/root/.config/mihomo name=mihomo src=/config/mihomo
```
8: –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã byedpi –∏ mihomo:
```
/container add interface=veth1 logging=yes mounts=mihomo root-dir=containers/mihomo start-on-boot=yes workdir=/ remote-image=registry-1.docker.io/vanes32/mihomo_nonft:1.19.12
/container add cmd="-Kt,h -s0+s -s3+s -s6+s -s9+s -s12+s -s15+s -s20+s -s30+s -An -Ku -a5 -An" dns=10.10.10.1 interface=veth2 logging=yes root-dir=containers/byedpi start-on-boot=yes workdir=/ remote-image="registry-1.docker.io/wiktorbgu/byedpi-mikrotik:latest"
```
9: –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä dns-—Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è –≤—Å–µ—Ö dhcp –∫–ª–∏–µ–Ω—Ç–æ–≤:
```
/ip dhcp-server network set dns-server=10.10.10.2 numbers=0
```
10: –ó–∞–ø—É—Å–∫–∞–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á—Ç–æ–±—ã –æ–Ω —Å–æ–∑–¥–∞–ª –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /mihomo/config –∏ –º—ã —É–±–µ–¥–∏–ª–∏—Å—å —á—Ç–æ –æ–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:

11: –í—ã–∫–ª—é—á–∏–º ipv6:
```
/ipv6/settings/set disable-ipv6=yes
```
12: –í–∫–ª—é—á–∏–º DOH –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ, –µ–≥–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∞–º —Ä–æ—É—Ç–µ—Ä –∏ byedpi-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
```
ip/dns/set use-doh-server=https://dns.google/dns-query verify-doh-cert=yes allow-remote-requests=yes
```
–†–∞–∑—Ä–µ—à–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
```
certificate/settings/set builtin-trust-anchors=trusted
```
13: –†–∞–∑—Ä–µ—à–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –¥–æ—Å—Ç—É–ø –∫ dns —Å–∞–º–æ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞
```
ip/firewall/filter/add place-before=[find comment="defconf: drop all not coming from LAN"] chain=input in-interface=dockers protocol=udp dst-port=53 action=accept comment="dockers dns"
```

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è mihomo:
13: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª mihomo /mihomo/config/config.yaml:
- –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ò–∑—É—á–∞–µ–º https://wiki.metacubex.one/ru/config/ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–¥ —Å–µ–±—è.
```
log-level: warning
profile:
  store-selected: true
  store-fake-ip: false
external-controller: 0.0.0.0:9090
external-ui: ui
external-ui-url: "https://github.com/MetaCubeX/Yacd-meta/archive/refs/heads/gh-pages.zip" # Get from GitHub Pages branch
ipv6: false
unified-delay: true

proxy-providers:
  sub:
    url: "https://xxxx" # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É (–î–ª—è –ø—Ä–∏–º–µ—Ä–∞)
    type: http
    interval: 86400
    proxy: DIRECT
    health-check:
      {
        enable: true,
        url: "https://www.gstatic.com/generate_204",
        interval: 86400,
      }
  links:
    type: file
    path: links.yaml # –§–∞–π–ª —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ —Ç–∏–ø–∞ vless://.. ss://.., –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞ mihomo. –û–¥–Ω–∞ —Å—Ç—Ä–æ–π—á–∫–∞ - –æ–¥–Ω–∞ —Å—Å—ã–ª–∫–∞.
    health-check:
      enable: true
      url: https://www.gstatic.com/generate_204
      interval: 300
      timeout: 5000
      lazy: true
      expected-status: 204

proxies:
  - name: "‚õìÔ∏è‚Äçüí•byedpi" # —Å–æ—Å–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å byedpi
    type: socks5
    server: 10.10.10.3 # –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ byedpi
    port: 1080 # socks5 –ø–æ—Ä—Ç
    udp: true

  - name: "warp" # AWG –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ warp (–î–ª—è –ø—Ä–∏–º–µ—Ä–∞)
    type: wireguard
    private-key: xxxx
    server: engage.cloudflareclient.com
    port: 2408
    ip: 172.16.0.2/32
    mtu: 1280
    public-key: xxxx
    allowed-ips: ['0.0.0.0/0']
    udp: true
    amnezia-wg-option:
        jc: 5
        jmin: 500
        jmax: 501
      # s1: 30
      # s2: 40
      # h1: 123456
      # h2: 67543
      # h4: 32345
      # h3: 123123

proxy-groups:
  - name: PROXY
    type: select
    exclude-filter: "üá∑üá∫"
    use:
      - sub
      - links

  - name: YouTube
    type: select
    proxies:
      - PROXY
      - warp
      - ‚õìÔ∏è‚Äçüí•byedpi
      - DIRECT
    filter: "üá∑üá∫"
    use:
      - sub
      - links

  - name: Discord
    type: select
    proxies:
      - PROXY
      - warp
      - ‚õìÔ∏è‚Äçüí•byedpi
      - DIRECT
    filter: "üá∑üá∫"
    use:
      - sub
      - links

  - name: cloudflare
    type: select
    proxies:
      - DIRECT
      - PROXY
      - warp
      - ‚õìÔ∏è‚Äçüí•byedpi
    filter: "üá∑üá∫"
    use:
      - sub
      - links

  - name: telegram
    type: select
    proxies:
      - DIRECT
      - PROXY
      - warp
      - ‚õìÔ∏è‚Äçüí•byedpi
    filter: "üá∑üá∫"
    use:
      - sub
      - links

  - name: quic # –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º quic
    type: select
    proxies:
      - PASS
      - REJECT

dns:
  enable: true
  listen: 0.0.0.0:53
  ipv6: false
  enhanced-mode: fake-ip
  respect-rules: true
  default-nameserver:
    - tls://9.9.9.9
  proxy-server-nameserver:
    - tls://9.9.9.9
  nameserver:
    - https://dns.adguard-dns.com/dns-query
  fake-ip-range: 198.18.0.1/15
  fake-ip-filter-mode: whitelist
  fake-ip-filter:
    - "RULE-SET:youtube"
    - "RULE-SET:x"
    - "RULE-SET:instagram"
    - "RULE-SET:facebook"
    - "RULE-SET:netflix"
    - "RULE-SET:openai"
    - "RULE-SET:discord"
    - "RULE-SET:tmdb"
    - "RULE-SET:intel"
    - "RULE-SET:google-deepmind"
    - "RULE-SET:medium"
    - "+.2ip.io"
    - "+.browserleaks.com"
    - "+.kinozal.tv"
    - "+.rutracker.org"
    - "+.rutracker.cc"
    - "+.nnmclub.to"
    - "+.rutor.org"
    - "+.servarr.com"
    - "+.prowlarr.com"
    - "+.clamav.net"
    - "+.strava.com"
    - "+.veeam.com"
    - "+.ntc.party"
    - "+.remna.st"
  nameserver-policy:
    "rule-set:category-gov-ru":
      - tls://77.88.8.8

listeners:
  - name: tun-in
    type: tun
    stack: system
    dns-hijack:
      - 0.0.0.0:53
    auto-detect-interface: true
    auto-route: true
    strict-route: true
    auto-redirect: true
    inet4-address:
      - 198.19.0.1/30

rules:
  - AND,((NETWORK,udp),(DST-PORT,443)),quic

  - DOMAIN,proactivebackend-pa.googleapis.com,DIRECT

  - DOMAIN-SUFFIX,2ip.io,PROXY
  - DOMAIN-SUFFIX,browserleaks.com,PROXY

  - RULE-SET,youtube,YouTube

  - RULE-SET,tmdb,PROXY
  - RULE-SET,medium,PROXY
  - RULE-SET,intel,PROXY
  - RULE-SET,netflix,PROXY
  - RULE-SET,openai,PROXY
  - RULE-SET,google-deepmind,PROXY
  - DOMAIN-SUFFIX,servarr.com,PROXY
  - DOMAIN-SUFFIX,prowlarr.com,PROXY
  - DOMAIN-SUFFIX,clamav.net,PROXY
  - DOMAIN-SUFFIX,strava.com,PROXY
  - DOMAIN-SUFFIX,veeam.com,PROXY

  - RULE-SET,x,PROXY
  - RULE-SET,facebook,PROXY
  - RULE-SET,instagram,PROXY
  - DOMAIN-SUFFIX,kinozal.tv,PROXY
  - DOMAIN-SUFFIX,rutracker.org,PROXY
  - DOMAIN-SUFFIX,rutracker.cc,PROXY
  - DOMAIN-SUFFIX,nnmclub.to,PROXY
  - DOMAIN-SUFFIX,rutor.org,PROXY
  - DOMAIN-SUFFIX,ntc.party,PROXY
  - DOMAIN-SUFFIX,remna.st,PROXY

# Discord
  - RULE-SET,discord,Discord
  - AND,((RULE-SET,discord_voice),(NETWORK,UDP),(DST-PORT,50000-50050)),Discord

# Cloudflare
  - RULE-SET,cloudflare,cloudflare

# Telegram
  - OR,((RULE-SET,telegram-cidr),(RULE-SET,telegram-domains)),telegram

rule-providers:
  facebook:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/facebook.mrs"
  instagram:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/instagram.mrs"
  x:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/x.mrs"
  netflix:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/netflix.mrs"
  openai:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/openai.mrs"
  discord:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/discord.mrs"
  tmdb:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/tmdb.mrs"
  medium:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/medium.mrs"
  youtube:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/youtube.mrs"
  intel:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/intel.mrs"
  google-deepmind:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/google-deepmind.mrs"
  discord_voice:
    type: http
    behavior: classical
    format: text
    url: "https://iplist.opencck.org/?format=clashx&data=cidr4&site=discord.gg"

  cloudflare:
    type: http
    behavior: ipcidr
    format: text
    url: "https://www.cloudflare.com/ips-v4/"

  telegram-cidr:
    type: http
    behavior: ipcidr
    format: text
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/telegram.list"

  telegram-domains: # –î–ª—è web-–∫–ª–∏–µ–Ω—Ç–∞
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/telegram.mrs"

  category-gov-ru:
    type: http
    behavior: domain
    format: mrs
    url: "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/meta/geo/geosite/category-gov-ru.mrs"
```
# Encrypted Client Hello (ECH)
–ò–Ω–æ–≥–¥–∞ —Å–∞–π—Ç—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–µ–π ECH –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è, –Ω–æ –µ—Å–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å/—Å–ª–æ–º–∞—Ç—å —ç—Ç—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é, —Ç–æ —Å–∞–π—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é mihomo –Ω–µ —É–º–µ–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å dns –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Ç–∏–ø—É –∑–∞–ø–∏—Å–µ–π (–∏–ª–∏ —è –Ω–µ –ø–æ–Ω—è–ª –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è). –≠—Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ dns –∑–∞–ø—Ä–æ—Å—ã –∏ —Ñ–∞–π—Ä–≤–æ–ª routeros –º–æ–∂–µ—Ç —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≤–∏—Ç—å –∏ –¥—Ä–æ–ø–∞—Ç—å.
```
/ip/firewall/filter/add action=drop chain=forward comment="drop dns type65" content="\00A\00\01" disabled=no dst-address=10.10.10.2 dst-port=53 in-interface-list=LAN protocol=udp place-before=[find comment="defconf: drop all from WAN not DSTNATed"]
```
–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–∫–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ ECH –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ê–≤—Ç–æ—Ä –º–µ—Ç–æ–¥–∏–∫–∏ @Medium_csgo


# Discord/Cloudflare/Telegram –∏ –ø—Ä–æ—á–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ ip –∞–¥—Ä–µ—Å–∞–º.

–¢–∞–∫ –∫–∞–∫ fakeip-—Ä–æ—É—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –¥–æ–º–µ–Ω–∞–º–∏ –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å ip –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ —Ü–µ–ª—ã–µ –ø–æ–¥—Å–µ—Ç–∏ –≤ mihomo, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è discord –∏ telegram. –î–ª—è —ç—Ç–æ–≥–æ:
1. C–æ–∑–¥–∞–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:
```
/routing/table/add name=to_mihomo fib
```
2. —Å –ø–æ–º–æ—à—å—é mangle –±—É–¥–µ–º –º–∞—Ä–∫–∏—Ä–æ–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ –Ω–∞–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
```
/ip firewall mangle
add action=mark-routing chain=prerouting connection-mark=to_mihomo in-interface-list=LAN new-routing-mark=to_mihomo
```
3. –ò—Å–∫–ª—é—á–∏–º –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ fasttrack:
```
:foreach i in=[/ip firewall filter find where (comment~"fasttrack" && !dynamic)] do={/ip firewall filter set $i connection-mark=no-mark}
```
4. –î–æ–±–∞–≤–∏–º –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞.
```
/ip/route/add dst-address=0.0.0.0/0 routing-table=to_mihomo gateway=10.10.10.2 comment="discord voice to mihomo"
```

# –ì–æ–ª–æ—Å–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã Discord:

1. –°–æ–∑–¥–∞–¥–∏–º —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å –∞–¥—Ä–µ—Å–ª–∏—Å—Ç —Å –ø–æ–¥—Å–µ—Ç—è–º–∏ –¥–∏—Å–∫–æ—Ä–¥–∞ —Å —Å–µ—Ä–≤–∏—Å–∞ https://iplist.opencck.org/:
```
/system script
add dont-require-permissions=no name=discord_voice owner=vanes policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=\
    "/tool/fetch mode=https url=\"https://iplist.opencck.org/\?format=mikrotik&data=cidr4&site=discord.gg\" dst-path=/tmp1/discord_voice.rsc;\r\
    \nimport /tmp1/discord_voice.rsc"
```
2. –í—ã–ø–æ–ª–Ω–∏–º —Å–∫—Ä–∏–ø—Ç, –æ–Ω —Å–æ–∑–¥–∞—Å—Ç –∞–¥—Ä–µ—Å –ª–∏—Å—Ç discord_cidr4 —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –ø–æ–¥—Å–µ—Ç—è–º–∏ –¥–∏—Å–∫–æ—Ä–¥–∞:
```
/system/script/run discord_voice
```
3. –°–æ–∑–¥–∞–¥–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ø–∏—Å–æ–∫:
```
/system scheduler
add interval=1d name=discord_voice on-event=discord_voice policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup
```
4: –ú–∞—Ä–∫–∏—Ä—É–µ–º udp —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö –∫ –≥–æ–ª–æ—Å–æ–≤—ã–º –ø–æ–¥—Å–µ—Ç—è–º –¥–∏—Å–∫–æ—Ä–¥–∞:
```
/ip firewall mangle
add action=mark-connection chain=prerouting comment="discord voice to mihomo" connection-mark=no-mark dst-address-list=discord_cidr4 dst-port=50000-50050 in-interface-list=LAN new-connection-mark=to_mihomo protocol=udp place-before=[find action=mark-routing]
```

# Cloudflare

–ù–∞–ø—Ä–∞–≤–∏–º –≤—Å–µ –ø–æ–¥—Å–µ—Ç–∏ Cloudflare –≤ mihomo —á—Ç–æ–±—ã –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º (–∞ –æ–Ω–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç) –±—ã–ª –≤—ã–±–æ—Ä –∫—É–¥–∞ –∏—Ö –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å. –í –∫–æ–Ω—Ñ–∏–≥–µ-–ø—Ä–∏–º–µ—Ä–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä, —Å –ø–æ–º–æ—à—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –∫—É–¥–∞ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å cloudflare.
1. –°–æ–∑–¥–∞–¥–∏–º —Å–∫—Ä–∏–ø—Ç –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—Å—Ç –∞–¥—Ä–µ—Å-–ª–∏—Å—Ç –∏–∑ –ø–æ–¥—Å–µ—Ç–µ–π cloudflare:
```
/system script
add dont-require-permissions=no name=cloudflare policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="/ip firewall address-list remove [find list=cloudflare]\r\
    \n/tool fetch url=\"https://www.cloudflare.com/ips-v4\" dst-path=\"tmp1/cloudflare.txt\" mode=https\r\
    \n:local fileName tmp1/cloudflare.txt\r\
    \n:local fileContent [/file get \$fileName contents]\r\
    \n:if ([:pick \$fileContent ([:len \$fileContent] - 1)] != \"\\n\") do={\r\
    \n    :set fileContent \"\$fileContent\\n\"\r\
    \n}\r\
    \n:local start 0\r\
    \n:local end 0\r\
    \n:local line \"\"\r\
    \n:local fileLength [:len \$fileContent]\r\
    \n:while (\$start < \$fileLength) do={\r\
    \n    :set end [:find \$fileContent \"\\n\" \$start]\r\
    \n    :if (\$end = -1) do={\r\
    \n        :set end \$fileLength\r\
    \n    }\r\
    \n\r\
    \n    :set line [:pick \$fileContent \$start \$end]\r\
    \n    :set start (\$end + 1)\r\
    \n    :if (\$line != \"\" && [:len \$line] > 0) do={\r\
    \n        /ip firewall address-list add list=cloudflare address=\$line comment=\"cloudflare\"\r\
    \n    }\r\
    \n}\r\
    \n/file remove \$fileName\r\
    \n"
```
2. –í—ã–ø–æ–ª–Ω–∏–º —Å–∫—Ä–∏–ø—Ç, –æ–Ω —Å–æ–∑–¥–∞—Å—Ç –∞–¥—Ä–µ—Å –ª–∏—Å—Ç c –ø–æ–¥—Å–µ—Ç—è–º–∏ cloudflare:
```
/system/script/run cloudflare
```
3. –°–æ–∑–¥–∞–¥–∏–º –∑–∞–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É –æ–±–Ω–æ–≤–ª—è—Ç—å –∞–¥—Ä–µ—Å–∞ cloudflare
```
/system scheduler
add interval=1w name=cloudflare on-event=cloudflare policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup
```
4. –î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–æ mangle –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –º–∞—Ä–∫–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –¥–æ –Ω—É–∂–Ω—ã—Ö –Ω–∞–º –ø–æ–¥—Å–µ—Ç–µ–π
```
/ip firewall mangle
add action=mark-connection chain=prerouting comment="cloudflare to_mihomo" connection-mark=no-mark dst-address-list=cloudflare in-interface-list=LAN new-connection-mark=to_mihomo place-before=[find action=mark-routing]
```

# Telegram

1. –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—é—â–∏–π address-list —Å –ø–æ–¥—Å–µ—Ç—è–º–∏ telegram
```
/system script
add dont-require-permissions=no name=telegram policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=":local ruleset \"telegram\"\r\
    \n:local addressList \$ruleset\r\
    \n\r\
    \n:local url (\"https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/\" . \$ruleset . \".list\")\r\
    \n:local fileName (\"geoip-\" . \$ruleset . \".txt\")\r\
    \n\r\
    \n/tool fetch url=\$url dst-path=\$fileName mode=https keep-result=yes\r\
    \n\r\
    \n:local content [/file get \$fileName contents]\r\
    \n:local line \"\"\r\
    \n:local char \"\"\r\
    \n:local length [:len \$content]\r\
    \n:local i 0\r\
    \n\r\
    \n:while (\$i < \$length) do={\r\
    \n    :set char [:pick \$content \$i (\$i + 1)]\r\
    \n\r\
    \n    :if (\$char = \"\\r\") do={} else={\r\
    \n        :if (\$char = \"\\n\") do={\r\
    \n\r\
    \n            :if (([:len \$line] > 0) && ([:pick \$line 0 1] != \"#\") && ([:find \$line \":\"] = [:nothing])) do={\r\
    \n                /ip firewall address-list add address=\$line list=\$addressList comment=\$ruleset\r\
    \n            }\r\
    \n\r\
    \n            :set line \"\"\r\
    \n        } else={\r\
    \n            :set line (\$line . \$char)\r\
    \n        }\r\
    \n    }\r\
    \n\r\
    \n    :set i (\$i + 1)\r\
    \n}\r\
    \n\r\
    \n:if (([:len \$line] > 0) && ([:pick \$line 0 1] != \"#\") && ([:find \$line \":\"] = [:nothing])) do={\r\
    \n    /ip firewall address-list add address=\$line list=\$addressList comment=\$ruleset\r\
    \n}\r\
    \n\r\
    \n/file remove \$fileName\r\
    \n"
```
2. –í—ã–ø–æ–ª–Ω–∏–º —Å–∫—Ä–∏–ø—Ç, –æ–Ω —Å–æ–∑–¥–∞—Å—Ç –∞–¥—Ä–µ—Å –ª–∏—Å—Ç c –ø–æ–¥—Å–µ—Ç—è–º–∏ telegram:
```
/system/script/run telegram
```
3. –°–æ–∑–¥–∞–¥–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ø–∏—Å–æ–∫:
```
/system scheduler
add interval=1d name=telegram on-event=telegram policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup
```
4. –ü—Ä–∞–≤–∏–ª–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è telegram
```
/ip firewall mangle
add action=mark-connection chain=prerouting comment="telegram to_mihomo" connection-mark=no-mark disabled=no dst-address-list=telegram in-interface-list=LAN new-connection-mark=to_mihomo place-before=[find action=mark-routing]
```